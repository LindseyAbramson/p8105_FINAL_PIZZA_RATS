---
title: "Visualizing the Data using Heatmaps"
output: 
  html_document:
    theme: darkly

---


```{r setup, include=FALSE}


library(tidyverse)
library(dplyr)
library(readxl)
library(haven)
library(glmnet)
library(sf)
library(RColorBrewer)
library(classInt)
library(ggspatial)
library(ggrepel)
library(patchwork)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```



```{r loading and merging data, include = FALSE}

# Zip code shapefile
zip_nyc =
  st_read("maps/MODZCTA_2010.shp") |> 
  rename(zipcode = MODZCTA) |> 
  select(zipcode, geometry)

# Basic plot
ggplot() +
  geom_sf(data = zip_nyc)

# DIssolving shapefile for just NYC boundary
NYC <- st_union(zip_nyc)

# Loading rat and restaurant data
zipcode_summary <- read_csv("data_small/zipcode_summary.csv") |> 
  mutate(
    zipcode = as.character(zipcode)
  )

# Joining rat and restaurant data with shapefile. Now, I have one file with the geometries for the map, and rat and pizza count data.
nyc_rat_pizza =
  zip_nyc |> 
  left_join(zipcode_summary, by = "zipcode")

```

```{r Rat map, include = FALSE}
# Rat count base map
ggplot() +
  geom_sf(
    data = nyc_rat_pizza,
    aes(fill = ratreport_count),
    color = "black",
    linewidth = .2
  ) 


# Looking at the different color palette options 
display.brewer.all(type = "seq")

# Examining distribution to figure out how to categorize data
nyc_rat_pizza |> 
  ggplot(aes(x = ratreport_count)) +
  geom_histogram()

# Right skewed data so using natural break jenks as opposed to quantiles
breaks_rat <- classIntervals(nyc_rat_pizza$ratreport_count, n = 5, style = "jenks")$brks
print(breaks_rat)

# Formatted Rat Map
ggplot() +
  geom_sf(                            # setting rat counts as my fill             
    data = nyc_rat_pizza,
    aes(fill = ratreport_count),
    color = "white",
    linewidth = .05
  )  +
  scale_fill_fermenter(               # indicating the color palette for the rat sightings map
    direction = 1,
    palette = "Greens",
    breaks = breaks_rat
  ) +
  geom_sf(                            # adding a thin black outline around map
    data = NYC,
    fill = NA,
    color = "black",
    linewidth = 0.03
  ) +
  labs(                                # adding title and subtitle 
    title = "Number of Rat Sightings in \nNew York City by Zipcode, 2025",
    subtitle = "Sightings as of November 2025", 
    fill = "Number of Sightings"
  ) +
  theme_void() +
  theme(                             # title and subtitle formatting and placement
    plot.title = element_text(face = "bold", size = 13, family = "sans", vjust = -20),
    plot.subtitle = element_text(face = "italic", size = 11, vjust = -3.5),
    legend.title = element_text(size = 10),
    legend.position = "inside",
    legend.position.inside = c(0.2, 0.6),
    legend.key.size = unit(.4, 'cm'),
    plot.margin = margin(0, 0, 0, 0),        
    panel.spacing = unit(0, "pt")            
  ) + 
  annotation_scale(                   # adding a scale bar
    style = "ticks",   
    pad_x = unit(1.4, "in"),
    pad_y = unit(.3, "in"),
    unit_category = "imperial"
  ) +
  annotation_north_arrow(             # adding a north arrow
    height = unit(.8, "cm"),
    width = unit(1, "cm"),
    pad_x = unit(1, "in"), 
    pad_y = unit(0.2, "in"),
    style = north_arrow_minimal 
    )  -> map_rat
```


```{r restaurant map, include = FALSE}
# Pizza count base map
ggplot() +
  geom_sf(
    data = nyc_rat_pizza,
    aes(fill = pizzarestaurant_count),
    color = "black",
    linewidth = .2
  ) 


# Select color palette and our breaks: 
display.brewer.all(type = "seq")

# Examine distribution to figure out how to categorize data
nyc_rat_pizza |> 
  ggplot(aes(x = pizzarestaurant_count)) +
  geom_histogram()

# Right skewed so using natural break jenks
breaks_pizza <- classIntervals(nyc_rat_pizza$pizzarestaurant_count, n = 5, style = "jenks")$brks
print(breaks_pizza)

# Formatted Pizza Map
ggplot() +
  geom_sf(                              # setting pizza counts as my fill
    data = nyc_rat_pizza,
    aes(fill = pizzarestaurant_count),
    color = "white",
    linewidth = .05
  )  +
  scale_fill_fermenter(                # indicating color palette
    direction = 1,
    palette = "Reds",
    breaks = breaks_pizza
  ) +
  geom_sf(                             # adding black border around map
    data = NYC,
    fill = NA,
    color = "black",
    linewidth = 0.03
  )  +
  labs(                                # adding title and subtitle 
    title = "Number of Pizza Restaurants \nin New York City by Zipcode, 2025",
    subtitle = "Includes by-the-slice and\nsit-down pizza restuarants", 
    fill = "Number of Pizza Restaurants"
  ) +
  theme_void() +
  theme(                              # formatting and placement of title, subtitle, legend
    plot.title = element_text(face = "bold", size = 13, family = "sans", vjust = -20),
    plot.subtitle = element_text(face = "italic", size = 11, vjust = -25),
    legend.title = element_text(size = 10),
    legend.position = "inside",
    legend.position.inside = c(0.2, 0.6),
    legend.key.size = unit(.4, 'cm'),
    plot.margin = margin(0, 0, 0, 0),        
    panel.spacing = unit(0, "pt")            
  ) +
  annotation_scale(                   # adding a scale bar
    style = "ticks",   
    pad_x = unit(1.4, "in"),
    pad_y = unit(.3, "in"),
    unit_category = "imperial"
  ) +
  annotation_north_arrow(             # adding a north arrow
    height = unit(.8, "cm"),
    width = unit(1, "cm"),
    pad_x = unit(1, "in"), 
    pad_y = unit(0.2, "in"),
    style = north_arrow_minimal 
    )  -> map_pizza
```


These maps illustrate the spatial distribution of rat sightings and pizza restaurants across New York City zipcodes. Most rat sightings are concentrated in central Brooklyn, particularly in neighborhoods such as Flatbush, Prospect Heights, and Bedford-Stuyvesant. A few zipcodes in the West Bronx and around Morningside Heights also show elevated rat activity.

In contrast, the distribution of pizza restaurants is more dispersed. Zipcodes with the highest numbers of pizza restaurants are spread across Manhattan, Queens, Brooklyn, and the Bronx, in neighborhoods such as Hellâ€™s Kitchen, Jackson Heights, Flatbush, and Long Island City.

There is only one zipcode with both a high number of rat sightings and a high number of pizza restaurants (11226, Flatbush). This suggests that pizza restaurant count alone may not be a strong predictor of rat activity. Other neighborhood-level factors must be contributing to variation in rat sightings across NYC.



```{r Joining the maps, fig.width=10, fig.height=12, include= FALSE}

# combining both maps to view side by side
map_rat + map_pizza -> combined_plot
print(combined_plot)

# saving the combined map
ggsave(
  "datavisualizations_files/nyc_maps.png", combined_plot,width = 12, height = 7,   
  dpi = 320, bg = "white"
)


```

```{r presenting the map, echo = FALSE, out.width='120%'}

# presenting map
knitr::include_graphics("datavisualizations_files/nyc_maps.png")

```

*Missing data represented using gray fill*